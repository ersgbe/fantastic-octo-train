<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trust Wallet Connect</title>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .button {
            background: linear-gradient(135deg, #3375BB, #4a90e2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }
        
        .button:hover {
            transform: translateY(-2px);
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .button-disconnect {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .wallet-info {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: left;
        }
        
        .address {
            font-family: monospace;
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
        }
        
        .balance {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Trust Wallet</h1>
        <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Å–≤–æ–π –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ DApp</p>
        
        <button id="connectBtn" class="button" onclick="connectWallet()">
            üîê –ü–æ–¥–∫–ª—é—á–∏—Ç—å Trust Wallet
        </button>
        
        <div id="status" class="status"></div>
        
        <div id="walletInfo" style="display: none;">
            <div class="wallet-info">
                <h3>‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω</h3>
                <p><strong>–ê–¥—Ä–µ—Å:</strong> <span id="walletAddress" class="address"></span></p>
                <p><strong>–ë–∞–ª–∞–Ω—Å:</strong> <span id="walletBalance" class="balance"></span> ETH</p>
                <p><strong>–°–µ—Ç—å:</strong> <span id="walletNetwork"></span></p>
                
                <button class="button button-disconnect" onclick="disconnectWallet()">
                    üîì –û—Ç–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫
                </button>
            </div>
        </div>
        
        <div class="wallet-info">
            <h3>üì± –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å:</h3>
            <p>‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–¥–∫–ª—é—á–∏—Ç—å Trust Wallet"</p>
            <p>‚Ä¢ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Trust Wallet</p>
            <p>‚Ä¢ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è</p>
            <p>‚Ä¢ –ì–æ—Ç–æ–≤–æ! –í–∞—à –∫–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω</p>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let walletConnectProvider = null;
        let web3 = null;
        let connectedAddress = null;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const connectBtn = document.getElementById('connectBtn');
        const statusEl = document.getElementById('status');
        const walletInfoEl = document.getElementById('walletInfo');
        const walletAddressEl = document.getElementById('walletAddress');
        const walletBalanceEl = document.getElementById('walletBalance');
        const walletNetworkEl = document.getElementById('walletNetwork');
        
        // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞
        function showStatus(message, type = 'success') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }
        
        // –°–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—É—Å
        function hideStatus() {
            statusEl.style.display = 'none';
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ WalletConnect URI
        function generateWalletConnectURI() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á –¥–ª—è —Å–µ—Å—Å–∏–∏
            const randomKey = Math.random().toString(36).substring(2) + 
                            Date.now().toString(36) + 
                            Math.random().toString(36).substring(2);
            
            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π URI –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏
            const wcURI = `wc:${randomKey}@1?bridge=https%3A%2F%2Fbridge.walletconnect.org&key=${btoa(randomKey).substring(0,64)}`;
            
            return wcURI;
        }
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
        async function connectWallet() {
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            try {
                connectBtn.disabled = true;
                connectBtn.textContent = '‚è≥ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...';
                hideStatus();
                
                if (isMobile) {
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π URI –¥–ª—è WalletConnect
                    const wcURI = generateWalletConnectURI();
                    console.log('Generated WC URI:', wcURI);
                    
                    if (isIOS) {
                        // Deeplink –¥–ª—è iOS Trust Wallet
                        const trustWalletDeeplink = `trust://wc?uri=${encodeURIComponent(wcURI)}`;
                        window.location.href = trustWalletDeeplink;
                        
                        // Fallback —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            if (!connectedAddress) {
                                window.location.href = 'https://apps.apple.com/app/trust-wallet/id1288339409';
                            }
                        }, 2000);
                        
                    } else if (isAndroid) {
                        // Intent –¥–ª—è Android Trust Wallet
                        const intentUrl = `intent://wc?uri=${encodeURIComponent(wcURI)}#Intent;package=com.wallet.crypto.trustapp;scheme=trust;end;`;
                        window.location.href = intentUrl;
                        
                        // Fallback —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            if (!connectedAddress) {
                                window.location.href = 'https://play.google.com/store/apps/details?id=com.wallet.crypto.trustapp';
                            }
                        }, 2000);
                    }
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WalletConnect –ø—Ä–æ–≤–∞–π–¥–µ—Ä
                    await initializeWalletConnect(wcURI);
                    
                } else {
                    // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º MetaMask –∏–ª–∏ WalletConnect
                    await initializeDesktopWallet();
                }
                
            } catch (error) {
                console.error('Connection error:', error);
                showStatus(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                resetConnectionButton();
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WalletConnect –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        async function initializeWalletConnect(wcURI) {
            try {
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä WalletConnect
                walletConnectProvider = new WalletConnectProvider.default({
                    rpc: {
                        1: "https://mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161",
                        56: "https://bsc-dataseed.binance.org/",
                        137: "https://polygon-rpc.com/"
                    },
                    chainId: 1,
                    qrcode: false,
                    connector: {
                        uri: wcURI
                    }
                });
                
                // –í–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä
                await walletConnectProvider.enable();
                
                // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä Web3
                web3 = new Web3(walletConnectProvider);
                
                // –ü–æ–ª—É—á–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç—ã
                const accounts = await web3.eth.getAccounts();
                connectedAddress = accounts[0];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                await updateWalletInfo();
                showStatus('‚úÖ –ö–æ—à–µ–ª–µ–∫ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!', 'success');
                
            } catch (error) {
                throw new Error(`WalletConnect error: ${error.message}`);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
        async function initializeDesktopWallet() {
            if (typeof window.ethereum !== 'undefined') {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º MetaMask
                web3 = new Web3(window.ethereum);
                
                try {
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    
                    connectedAddress = accounts[0];
                    await updateWalletInfo();
                    showStatus('‚úÖ MetaMask —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!', 'success');
                    
                } catch (error) {
                    throw new Error(`MetaMask connection denied: ${error.message}`);
                }
                
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º WalletConnect —Å QR –∫–æ–¥–æ–º –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
                await initializeWalletConnectWithQR();
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WalletConnect —Å QR –∫–æ–¥–æ–º –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
        async function initializeWalletConnectWithQR() {
            const wcURI = generateWalletConnectURI();
            
            walletConnectProvider = new WalletConnectProvider.default({
                rpc: {
                    1: "https://mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161",
                    56: "https://bsc-dataseed.binance.org/",
                    137: "https://polygon-rpc.com/"
                },
                chainId: 1,
                qrcode: true,
                connector: {
                    uri: wcURI
                }
            });
            
            await walletConnectProvider.enable();
            web3 = new Web3(walletConnectProvider);
            
            const accounts = await web3.eth.getAccounts();
            connectedAddress = accounts[0];
            
            await updateWalletInfo();
            showStatus('‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω —á–µ—Ä–µ–∑ WalletConnect!', 'success');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ—à–µ–ª—å–∫–µ
        async function updateWalletInfo() {
            if (!connectedAddress || !web3) return;
            
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å
                walletAddressEl.textContent = connectedAddress;
                
                // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å
                const balance = await web3.eth.getBalance(connectedAddress);
                const balanceInEth = web3.utils.fromWei(balance, 'ether');
                walletBalanceEl.textContent = parseFloat(balanceInEth).toFixed(4);
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ç–∏
                const networkId = await web3.eth.getChainId();
                const networkName = getNetworkName(networkId);
                walletNetworkEl.textContent = `${networkName} (ID: ${networkId})`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ—à–µ–ª—å–∫–µ
                walletInfoEl.style.display = 'block';
                connectBtn.style.display = 'none';
                
            } catch (error) {
                console.error('Error updating wallet info:', error);
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Å–µ—Ç–∏ –ø–æ ID
        function getNetworkName(networkId) {
            const networks = {
                1: 'Ethereum Mainnet',
                56: 'Binance Smart Chain',
                137: 'Polygon',
                42161: 'Arbitrum',
                10: 'Optimism'
            };
            return networks[networkId] || `Unknown Network (${networkId})`;
        }
        
        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
        async function disconnectWallet() {
            try {
                if (walletConnectProvider) {
                    await walletConnectProvider.disconnect();
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                walletConnectProvider = null;
                web3 = null;
                connectedAddress = null;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                walletInfoEl.style.display = 'none';
                connectBtn.style.display = 'block';
                resetConnectionButton();
                
                showStatus('–ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω', 'success');
                
            } catch (error) {
                console.error('Disconnect error:', error);
                showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏', 'error');
            }
        }
        
        // –°–±—Ä–æ—Å –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function resetConnectionButton() {
            connectBtn.disabled = false;
            connectBtn.textContent = 'üîê –ü–æ–¥–∫–ª—é—á–∏—Ç—å Trust Wallet';
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∏–∑ Trust Wallet
        function handleWalletConnectCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const wcUri = urlParams.get('uri');
            const connected = urlParams.get('connected');
            
            if (wcUri && connected === 'true') {
                showStatus('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'success');
                initializeWalletConnect(wcUri);
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–µ—Ä–Ω—É–ª–∏—Å—å –ª–∏ –º—ã –∏–∑ Trust Wallet —Å callback
        window.addEventListener('load', function() {
            // –û—á–∏—â–∞–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            if (window.location.search.includes('connected=true')) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            checkExistingConnection();
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
        async function checkExistingConnection() {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
            // –ù–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ localStorage –∏–ª–∏ sessionStorage
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–µ–Ω–∏–ª –∞–∫–∫–∞—É–Ω—Ç –≤ Trust Wallet)
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function(accounts) {
                if (accounts.length === 0) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª –∫–æ—à–µ–ª–µ–∫
                    disconnectWallet();
                } else {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–µ–Ω–∏–ª –∞–∫–∫–∞—É–Ω—Ç
                    connectedAddress = accounts[0];
                    updateWalletInfo();
                    showStatus('–ê–∫–∫–∞—É–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω', 'success');
                }
            });
            
            window.ethereum.on('chainChanged', function(chainId) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–µ–Ω–∏–ª —Å–µ—Ç—å
                updateWalletInfo();
                showStatus('–°–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞', 'success');
            });
        }
    </script>
</body>
</html>
