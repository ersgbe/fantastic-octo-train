<!DOCTYPE html>
<html>
<head>
    <title>Крипто-тревожная кнопка</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
</head>
<body>
    <h2>Экстренный перевод средств</h2>

    <!-- БЛОК 1: Подключение кошелька -->
    <button id="connectWallet">Подключить MetaMask</button>
    <p id="walletInfo">Кошелек не подключен</p>

    <!-- БЛОК 2: Ввод БЕЗОПАСНОГО адреса -->
    <div>
        <label for="safeAddress">Ваш безопасный адрес для перевода:</label><br>
        <input type="text" id="safeAddress" placeholder="0x..." style="width: 500px;"><br>
        <small>Внимание! Убедитесь, что адрес корректен и вы контролируете его.</small>
    </div>

    <!-- БЛОК 3: Кнопка для перевода ETH -->
    <button id="emergencyETH" disabled>Перевести ETH на безопасный адрес</button>

    <script>
        let web3;
        let userAccount;

        // БЛОК 1: Подключение кошелька
        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (window.ethereum) {
                try {
                    // Запрос доступа к аккаунтам
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    web3 = new Web3(window.ethereum);
                    userAccount = accounts[0];
                    document.getElementById('walletInfo').textContent = `Подключен: ${userAccount}`;
                    // Активируем кнопку перевода после подключения
                    document.getElementById('emergencyETH').disabled = false;
                } catch (error) {
                    console.error("Ошибка подключения:", error);
                }
            } else {
                alert('Пожалуйста, установите MetaMask!');
            }
        });

        // БЛОК 3: Функция экстренного перевода ETH
        document.getElementById('emergencyETH').addEventListener('click', async () => {
            // !!! ВАЖНО: Берем адрес из поля ввода, а не из кода !!!
            const safeAddress = document.getElementById('safeAddress').value;

            // Простая проверка адреса
            if (!web3.utils.isAddress(safeAddress)) {
                alert('Укажите корректный адрес!');
                return;
            }

            if (!userAccount) {
                alert('Сначала подключите кошелек');
                return;
            }

            if (confirm('ВЫ УВЕРЕНЫ? Это действие отправит весь ваш ETH на указанный адрес. Отменить транзакцию будет невозможно.')) {
                try {
                    // Получаем баланс текущего аккаунта
                    const balance = await web3.eth.getBalance(userAccount);
                    // Рассчитываем комиссию (газ). Оставляем небольшой запас, например, 0.001 ETH.
                    const gasPrice = await web.eth.getGasPrice();
                    const gasLimit = 21000; // Стандартный лимит газа для простого перевода ETH
                    const gasCost = web3.utils.toBN(gasPrice).mul(web3.utils.toBN(gasLimit));

                    // Сумма к переводу = весь баланс минус预估ные комиссии
                    const amountToSend = web3.utils.toBN(balance).sub(gasCost);

                    // Проверяем, что после комиссии остались средства для перевода
                    if (amountToSend.lte(web3.utils.toBN(0))) {
                        alert('Недостаточно ETH для покрытия комиссии сети.');
                        return;
                    }

                    // Создаем и отправляем транзакцию
                    const tx = {
                        from: userAccount,
                        to: safeAddress, // Перевод на ВАШ адрес
                        value: amountToSend,
                        gas: gasLimit,
                        gasPrice: gasPrice
                    };

                    // Подписываем и отправляем транзакцию через MetaMask
                    const receipt = await web3.eth.sendTransaction(tx);
                    console.log('Транзакция успешна:', receipt);
                    alert(`Средства успешно отправлены! Хэш транзакции: ${receipt.transactionHash}`);

                } catch (error) {
                    console.error('Ошибка при переводе:', error);
                    alert('Произошла ошибка: ' + error.message);
                }
            }
        });
    </script>
</body>
</html>
